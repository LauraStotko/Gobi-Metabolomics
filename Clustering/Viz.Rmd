---
title: "Cluster Visualization"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# Load the data
data <- read.csv("/Users/laura.stotko/Documents/Gobi-Metabolomics/Clustering/mfuzz_clusters_by_challenge_with_time_respone.csv")

# Clean column names
colnames(data) <- make.names(colnames(data), unique = TRUE)

# Sicherstellen, dass die response-Spalte numerisch ist
data$Response <- as.numeric(data$Response)

# Definiere alle möglichen Timepoint-Werte
all_Timepoints <- seq(0, 240, 60)

# Individuelle Linien-Daten vorbereiten (alle Response-Werte in Long-Format bringen)
individual_data <- data %>%
  complete(Assigned_Cluster, Challenge, Timepoint = all_Timepoints) %>% # Fehlende Zeitpunkte auffüllen
  group_by(Assigned_Cluster, Challenge) %>%
  mutate(Response = zoo::na.approx(Response, x = Timepoint, na.rm = FALSE)) %>%
  ungroup()

# Mittelwert-Daten vorbereiten
mean_profiles <- data %>%
  group_by(Assigned_Cluster, Challenge, Timepoint) %>%
  summarise(Mean_Response = mean(Response, na.rm = TRUE), .groups = "drop") %>%
  complete(Assigned_Cluster, Challenge, Timepoint = all_Timepoints) %>% # Fehlende Zeitpunkte auffüllen
  group_by(Assigned_Cluster, Challenge) %>%
  mutate(Mean_Response = zoo::na.approx(Mean_Response, x = Timepoint, na.rm = FALSE)) %>%
  ungroup()

# Verzeichnis für gespeicherte Plots erstellen
output_dir <- "/Users/laura.stotko/Documents/Gobi-Metabolomics/Clustering/Plots"
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

# Alle Cluster gemeinsam visualisieren
p_all <- ggplot() +
  # Individuelle Linien in hellgrau (Hintergrund)
  geom_line(data = individual_data, 
            aes(x = Timepoint, y = Response, group = interaction(Assigned_Cluster, Challenge)), 
            color = "lightgrey", size = 0.5, alpha = 0.5) +
  # Mittelwertlinien farblich hervorgehoben
  geom_line(data = mean_profiles, 
            aes(x = Timepoint, y = Mean_Response, color = Challenge), 
            size = 1.2) +
  facet_wrap(~ Assigned_Cluster, ncol = 4) +  # Alle Cluster nebeneinander anzeigen
  scale_y_continuous() +
  scale_x_continuous(limits = c(0, 240), breaks = seq(0, 240, 60)) +
  labs(title = "All Clusters - Challenges",
       x = "Challenge Time [min]", 
       y = "Metabolite Response") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
    strip.background = element_rect(fill = "white", color = "black"),
    strip.text = element_text(size = 10),
    legend.position = "top",
    panel.spacing = unit(1, "lines")
  )

# Plot speichern
ggsave(filename = paste0(output_dir, "/All_Clusters.png"), plot = p_all, width = 16, height = 8)

# Plot anzeigen
print(p_all)

```




