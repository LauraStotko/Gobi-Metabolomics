---
title: "Gobi: Pre-processing clean"
author: "Marie Hackenberg"
date: "2025-02-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load libraries
```{r}
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(missForest)
library(doParallel)
```

# Load data
```{r}
path_metabolon <- "../data/raw/humet_data_raw_none_metablon.csv"
path_biocrates <- "../data/raw/humet_data_raw_none_biocrates.csv"
path_inhouse <- "../data/raw/humet_data_raw_none_in_house_biochemistry.csv"

data_metabolon <- read.csv(path_metabolon, sep = ",", header = TRUE)
data_biocrates <- read.csv(path_biocrates, sep = ",", header = TRUE)
data_inhouse <- read.csv(path_inhouse, sep = ",", header = TRUE)

# Add platform column
data_metabolon <- cbind(platform_name = "Metabolon HD4 [nt-ms]", data_metabolon)
data_biocrates <- cbind(platform_name = "Biocrates p150 [t-ms]", data_biocrates)
data_inhouse <- cbind(platform_name = "In-house biochemistry [chem.]", data_inhouse)

# Add challenge column depending on time to one version
add_challenge <- function(dataset) {
  dataset %>%
  mutate(challenge = case_when(
    time >= 1 & time <= 9 ~ "fasting",
    time >= 33 & time <= 39 ~ "exercise",
    time >= 40 & time <= 49 ~ "oltt",
    TRUE ~ NA_character_ # assign NA for any time outside ranges
    )) %>%
  dplyr::select(challenge, everything()) # make challenge the first column
}

data_metabolon <- add_challenge(data_metabolon)
data_biocrates <- add_challenge(data_biocrates)
data_inhouse <- add_challenge(data_inhouse)

# Filter half the data for relevant timepoints only
relevant_timepoints <- function(dataset) {
  dataset %>%
    filter(!is.na(challenge))  # remove rows where 'challenge' is NA
}

data_metabolon_filtered_first <- relevant_timepoints(data_metabolon)
data_biocrates_filtered_first <- relevant_timepoints(data_biocrates)
data_inhouse_filtered_first <- relevant_timepoints(data_inhouse)

data_metabolon_filtered_last <- data_metabolon
data_biocrates_filtered_last <- data_biocrates
data_inhouse_filtered_last <- data_inhouse
```

# Identify and remove artefacts
Filtering for outliers defined as data points beyond four standard deviations from the mean and for time points measured after the first 30 minutes of a study challenge, then inspecting manually before removing artefacts is already done in the downloaded dataset.

# Impute missing values using missForest
```{r}
# Prepare data
to_factor <- function(dataset) {
  dataset %>%
  mutate(
    challenge = as.factor(challenge),
    platform_name = as.factor(platform_name),
    time = as.numeric(as.character((time))),
    subject = as.factor(subject),
    )
}

data_metabolon_filtered_first <- to_factor(data_metabolon_filtered_first)
data_biocrates_filtered_first <- to_factor(data_biocrates_filtered_first)
data_inhouse_filtered_first <- to_factor(data_inhouse_filtered_first)

data_metabolon_filtered_last <- to_factor(data_metabolon_filtered_last)
data_biocrates_filtered_last <- to_factor(data_biocrates_filtered_last)
data_inhouse_filtered_last <- to_factor(data_inhouse_filtered_last)
```

## Exclude metabolites with more than 30% missing data points
```{r}
keep_sub_30 <- function(dataset) {
  # Count total columns before filtering
  total_cols_before <- ncol(dataset)
  
  # Identify columns with more than 30% missing values
  missing_threshold <- 0.3  # 30% threshold
  cols_to_keep <- colMeans(is.na(dataset)) < missing_threshold | colnames(dataset) == "challenge" # keep challenge column
  
  # Count total columns after filtering
  total_cols_after <- sum(cols_to_keep)
  
  # Filter the dataset to exclude high-missing-value columns
  dataset <- dataset[, cols_to_keep]
  
  # Calculate  number of removed columns
  removed_cols <- total_cols_before - total_cols_after
  
  # Print number of removed columns
  cat("Number of removed columns:", removed_cols, "\n")
  
  return(dataset)
}

data_metabolon_filtered_first <- keep_sub_30(data_metabolon_filtered_first)
data_biocrates_filtered_first <- keep_sub_30(data_biocrates_filtered_first)
data_inhouse_filtered_first <- keep_sub_30(data_inhouse_filtered_first)

data_metabolon_filtered_last <- keep_sub_30(data_metabolon_filtered_last)
data_biocrates_filtered_last <- keep_sub_30(data_biocrates_filtered_last)
data_inhouse_filtered_last <- keep_sub_30(data_inhouse_filtered_last)

cat("Number of NA in data_metabolon_filtered_first:", sum(is.na(data_metabolon_filtered_first)), "\n")
cat("Number of NA in data_biocrates_filtered_first:", sum(is.na(data_biocrates_filtered_first)), "\n")
cat("Number of NA in data_inhouse_filtered_first:", sum(is.na(data_inhouse_filtered_first)), "\n")

cat("Number of NA in data_metabolon:", sum(is.na(data_metabolon_filtered_last)), "\n")
cat("Number of NA in data_biocrates:", sum(is.na(data_biocrates_filtered_last)), "\n")
cat("Number of NA in data_inhouse:", sum(is.na(data_inhouse_filtered_last)), "\n")
```

# Performing missForest
```{r}
mF_function <- function(dataset) {
  cat("NA in ",  deparse(substitute(dataset)), " before missForest:", sum(is.na(dataset)), "\n")
  
  if(!sum(is.na(dataset)) == 0) {
    # Set up parallel backend using all available cores minus one
    cl <- makeCluster(detectCores() - 1, type = "FORK")  # Use one less core to avoid overloading; Mac-specific "FORK" cluster type
    registerDoParallel(cl)
    
    # Perform missForest imputation
    set.seed(42)  # Ensures reproducibility
    imputed_dataset <- missForest(dataset, ntree = 450, parallelize = "variables", verbose = "TRUE") # default ntree = 100; verbose=True to get progress messages              # ACHTUNG: DAUERT LANGE!!
    
    stopCluster(cl)  # Stop  cluster after imputation
    
    # Extract imputed dataset
    imputed_dataset <- imputed_dataset$ximp
  } else {
    imputed_dataset <- dataset
  }
  cat("NA in ",  deparse(substitute(dataset)), " after missForest:", sum(is.na(imputed_dataset)), "\n")
  
  return(imputed_dataset)
}

#imputed_metabolon_filtered_first <- mF_function(data_metabolon_filtered_first)
#imputed_biocrates_filtered_first <- mF_function(data_biocrates_filtered_first) # Marie
#imputed_inhouse_filtered_first <- mF_function(data_inhouse_filtered_first) # Anna

#imputed_metabolon_filtered_last <- mF_function(data_metabolon_filtered_last)
#imputed_biocrates_filtered_last <- mF_function(data_biocrates_filtered_last) # Laura
#imputed_inhouse_filtered_last <- mF_function(data_inhouse_filtered_last) # Diana
```

# Log2 Transform
```{r}
log2_transformed <- function(dataset) {
  dataset %>%
    mutate(time = as.factor(time)) %>% # refactor time column as factor to exclude from log2_transformation
    mutate(across(where(is.numeric), log2))
}

#log2_imputed_metabolon_filtered_first <- log2_transformed(imputed_metabolon_filtered_first)
#log2_imputed_biocrates_filtered_first <- log2_transformed(imputed_biocrates_filtered_first) # Marie
#log2_imputed_inhouse_filtered_first <- log2_transformed(imputed_inhouse_filtered_first) # Anna

#log2_imputed_metabolon_filtered_last <- log2_transformed(imputed_metabolon_filtered_last)
#log2_imputed_biocrates_filtered_last <- log2_transformed(imputed_biocrates_filtered_last) # Laura
#log2_imputed_inhouse_filtered_last <- log2_transformed(imputed_inhouse_filtered_last) # Diana
```


# Filter unfiltered data for relevant timepoints
```{r}
relevant_timepoints <- function(dataset) {
  dataset %>%
    filter(!is.na(challenge))  # remove rows where 'challenge' is NA
}

#log2_imputed_metabolon_filtered_last <- relevant_timepoints(log2_imputed_metabolon_filtered_last)
#log2_imputed_biocrates_filtered_last <- relevant_timepoints(log2_imputed_biocrates_filtered_last) # Laura
#log2_imputed_inhouse_filtered_last <- relevant_timepoints(log2_imputed_inhouse_filtered_last) # Diana
```

```{r}
# Save to a CSV file
#write.csv(log2_imputed_metabolon_filtered_first, "../figures/log2_imputed_metabolon_filtered_first.csv", row.names = FALSE)
#write.csv(log2_imputed_biocrates_filtered_first, "../figures/log2_imputed_biocrates_filtered_first.csv", row.names = FALSE) # Marie
#write.csv(log2_imputed_inhouse_filtered_first, "../figures/log2_imputed_inhouse_filtered_first.csv", row.names = FALSE) # Anna
#write.csv(log2_imputed_metabolon_filtered_last, "../figures/log2_imputed_metabolon_filtered_last.csv", row.names = FALSE)
#write.csv(log2_imputed_biocrates_filtered_last, "../figures/log2_imputed_biocrates_filtered_last.csv", row.names = FALSE) # Laura
#write.csv(log2_imputed_inhouse_filtered_last, "../figures/log2_imputed_inhouse_filtered_last.csv", row.names = FALSE) # Diana
```
# End